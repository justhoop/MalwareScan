#Requires -RunAsAdministrator
<#
.synopsis
Download and run a few anti-malware programs

.example
Start-MalwareScan. Need to add a cleanup function.
#>

function Get-Tool {
    param (
        [string]$url,
        [string]$filename
    )
    try {
        $result = Invoke-WebRequest -Uri $url -OutFile $filename -PassThru -UseBasicParsing
        if($result.StatusCode -eq 200){
            return $true
        }
        else{
            return $false
        }
    }
    catch {
        Write-Host "Unable to download $url" 
        return $false
    }
}

function Start-StingerScan {
    Write-Host "Downloading Stinger"
    if (Get-Tool -url "http://downloadcenter.mcafee.com/products/mcafee-avert/stinger/stinger32.exe" -filename "c:\MalwareTools\stinger32.exe") {
        Start-Process -FilePath "c:\MalwareTools\stinger32.exe" -ArgumentList "--ADL --GO" -Verb runas -Wait
        if (Test-Path "C:\MalwareTools\Stinger*.html") {
            Invoke-Item "C:\MalwareTools\Stinger*.html"
        }
    }
}

function Start-GetSuspScan {
    Write-Host "Downloading GetSusp"
    if (Get-Tool -url "http://downloadcenter.mcafee.com/products/mcafee-avert/getsusp/getsusp64.exe" -filename "c:\MalwareTools\getsusp64.exe") {
        Write-Host "Running GetSusp64" 
        Start-Process -FilePath "c:\MalwareTools\getsusp64.exe" -ArgumentList "--silent" -Verb runas -Wait
        if(Test-Path "C:\MalwareTools\GetSusp.xml"){
            Invoke-Item "C:\MalwareTools\GetSusp.xml"
        }
    }
}

function Start-MSERT {
    Write-Host "Downloading Microsoft Safety Scanner"
    if (Get-Tool -url "https://go.microsoft.com/fwlink/?LinkId=212732" -filename "c:\MalwareTools\msert.exe") {
        Write-Host "Running GetSusp64" 
        Start-Process -FilePath "c:\MalwareTools\msert.exe" -ArgumentList "/F" -Verb runas -Wait
        if(Test-Path "C:\Windows\debug\msert.log"){
            Invoke-Item "C:\Windows\Debug\msert.log"
        }
    }
}

function Start-MBAMScan {
    Write-Host "Downloading Malwarebytes"
    if (Get-Tool -url "http://downloads.malwarebytes.com/file/mb4_offline" -filename "c:\MalwareTools\mb4-setup.exe") {
        Write-Host "Installing Malwarebytes. Turn off Access Protection."
        pause
        Start-Process -FilePath "c:\MalwareTools\mb4-setup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART" -Wait -Verb runas
        Start-Process -FilePath "C:\Program Files\Malwarebytes\Anti-Malware\mbam.exe" -Verb runas -Wait
    }
}

if (-not (test-path -path "c:\MalwareTools")) {
    New-item -Path "c:\MalwareTools" -ItemType Directory
}
 
Start-GetSuspScan
Start-StingerScan
Start-MSERT
Start-MBAMScan